name: Discord notify (dependabot merged into dev)

on:
  push:
    branches: [dev]

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord webhook (dependabot only)
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
        run: |
          set -euo pipefail

          # Dependabot由来のマージコミットを判定（運用に合わせて調整）
          if ! echo "$COMMIT_MSG" | grep -Eqi 'dependabot|^Bump '; then
            echo "Skip: not a dependabot-related commit"
            echo "commit_msg=$COMMIT_MSG"
            exit 0
          fi

          payload=$(jq -n \
            --arg content "✅ **Dependabot merged into dev**\n- Repo: $REPO\n- Actor: $ACTOR\n- Commit: $SHA\n- Message: $COMMIT_MSG\n- $URL" \
            '{content:$content}')

          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
