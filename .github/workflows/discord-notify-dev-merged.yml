name: Discord notify (merged into dev)

on:
  pull_request:
    types: [closed]

permissions:
  contents: read

jobs:
  notify:
    # PRがmergeされ、baseがdevのときだけ
    if: github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'dev'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          TITLE: ${{ github.event.pull_request.title }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          MERGED_BY: ${{ github.event.pull_request.merged_by.login }}
          NUMBER: ${{ github.event.pull_request.number }}
        run: |
          payload=$(jq -n \
            --arg content "✅ **Merged into dev** (#$NUMBER)\n- Repo: $REPO\n- Title: $TITLE\n- Author: $AUTHOR\n- Merged by: $MERGED_BY\n- $PR_URL" \
            '{content:$content}')
          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL"
