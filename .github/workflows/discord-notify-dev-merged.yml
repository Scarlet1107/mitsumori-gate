name: Discord notify (dependabot merged into dev) + debug

on:
  pull_request_target:
    types: [closed]
    branches: [dev]

permissions:
  pull-requests: read

jobs:
  debug:
    runs-on: ubuntu-latest
    steps:
      - name: Dump key context
        shell: bash
        run: |
          set -euo pipefail
          echo "=== Event Summary ==="
          echo "event_name=${GITHUB_EVENT_NAME}"
          echo "actor=${GITHUB_ACTOR}"
          echo "ref=${GITHUB_REF}"
          echo "sha=${GITHUB_SHA}"
          echo ""
          echo "=== pull_request fields ==="
          # GITHUB_EVENT_PATH ã¯ã‚¤ãƒ™ãƒ³ãƒˆJSONãŒå…¥ã£ã¦ã‚‹
          jq -r '
            {
              action: .action,
              base_ref: .pull_request.base.ref,
              merged: .pull_request.merged,
              merged_at: .pull_request.merged_at,
              pr_number: .pull_request.number,
              pr_title: .pull_request.title,
              pr_user: .pull_request.user.login,
              merge_commit_sha: .pull_request.merge_commit_sha,
              html_url: .pull_request.html_url
            }' "$GITHUB_EVENT_PATH"

          echo ""
          echo "=== Job Summary ===" >> "$GITHUB_STEP_SUMMARY"
          jq -r '
            [
              "## Discord notify debug",
              "",
              "- event: \(.action)",
              "- base: \(.pull_request.base.ref)",
              "- merged: \(.pull_request.merged)",
              "- pr: #\(.pull_request.number) \(.pull_request.title)",
              "- pr_user: \(.pull_request.user.login)",
              "- merge_sha: \(.pull_request.merge_commit_sha // "null")",
              "- url: \(.pull_request.html_url)"
            ] | join("\n")' "$GITHUB_EVENT_PATH" >> "$GITHUB_STEP_SUMMARY"

  notify:
    needs: [debug]
    runs-on: ubuntu-latest

    # ã“ã“ã§ã€Œæ¡ä»¶ã«åˆã†ã¨ãã ã‘ã€é€šçŸ¥å‡¦ç†ã‚’å®Ÿè¡Œ
    if: >
      github.event.pull_request.merged == true &&
      github.event.pull_request.user.login == 'dependabot[bot]'

    steps:
      - name: Send Discord webhook (success)
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          MERGE_SHA: ${{ github.event.pull_request.merge_commit_sha }}
          MERGED_BY: ${{ github.actor }}
        run: |
          set -euo pipefail

          if [[ -z "${DISCORD_WEBHOOK_URL:-}" ]]; then
            echo "DISCORD_WEBHOOK_URL is empty. (Secrets not available?)" >&2
            exit 1
          fi

          payload=$(jq -n \
            --arg content "âœ… **Dependabot merged into dev**\n- Repo: $REPO\n- PR: $PR_TITLE\n- Merged by: $MERGED_BY\n- Merge commit: $MERGE_SHA\n- $PR_URL" \
            '{content:$content}')

          # å¤±æ•—ç†ç”±ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹/ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—
          http_code=$(curl -sS -o /tmp/discord_resp.txt -w "%{http_code}" \
            -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" || true)

          echo "Discord HTTP status: $http_code"
          echo "Discord response:"
          cat /tmp/discord_resp.txt || true

          # Discordã¯é€šå¸¸204 No ContentãŒæˆåŠŸ
          if [[ "$http_code" != "204" ]]; then
            echo "Discord webhook failed (expected 204)." >&2
            exit 1
          fi

      - name: Failure report to Discord (only if notify failed)
        if: failure()
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          # ã“ã“ã¾ã§æ¥ã¦ã‚‹æ™‚ç‚¹ã§ secret ãŒç©ºã®å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ guard
          if [[ -z "${DISCORD_WEBHOOK_URL:-}" ]]; then
            echo "Cannot send failure report: DISCORD_WEBHOOK_URL empty." >&2
            exit 0
          fi

          # é‡è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘è¼‰ã›ã‚‹ï¼ˆé•·ã™ãé˜²æ­¢ï¼‰
          info=$(jq -r '
            {
              action: .action,
              base: .pull_request.base.ref,
              merged: .pull_request.merged,
              pr_user: .pull_request.user.login,
              pr: ("#" + (.pull_request.number|tostring) + " " + .pull_request.title),
              url: .pull_request.html_url
            } | tostring' "$GITHUB_EVENT_PATH")

          payload=$(jq -n --arg content "ğŸš¨ **Discord notify failed**\n```$info```" '{content:$content}')
          curl -sS -H "Content-Type: application/json" -d "$payload" "$DISCORD_WEBHOOK_URL" || true
