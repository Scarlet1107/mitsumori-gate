# 住宅予算シミュレーション POC

住宅ローンの借入可能額と希望条件に基づく予算感を確認できる最小構成のプロトタイプです。顧客が来店前／来店時に必要情報を入力すると、借入可能上限額・希望条件での借入額・参考延床面積を算出して保存できます。

## セットアップ

1. 依存関係をインストール
    ```bash
    npm install
    ```
2. `.env` に `DATABASE_URL` を設定
3. Prisma のマイグレーションを適用（初回は任意の名前で OK）
    ```bash
    npx prisma migrate dev --name init-simulations
    ```
4. 開発サーバーを起動
    ```bash
    npm run dev
    ```

ブラウザで [http://localhost:3000/consent](http://localhost:3000/consent) にアクセスし、同意後に表示されるステップフローでシミュレーターを利用できます。（既存の intake フローを拡張しています。）

## テストと品質確認

- 型／Lint: `npm run lint`
- ユニットテスト（バリデーションと試算ロジック）: `npm test`

※ 実行環境によっては Vitest がワーカースレッドを利用できずエラーになる場合があります。その場合は Node.js のワーカースレッドを許可するか、CI 上で実行してください。

## 設定値の一元管理

金利・返済比率・坪単価などの係数は `lib/simulation/config.ts` の `defaultSimulationConfig` でまとめて管理しています。必要に応じて環境変数や管理画面から上書きできるように `createSimulationConfig` を用意しています。

## 保存データ

`prisma/schema.prisma` の `Simulation` モデルに入力値と算出結果を保存します。保存 API は `POST /api/simulations` で、フロントエンドの「この内容で保存」ボタンから呼び出されます。メール通知は将来的に実装予定のため、現在は空のフック `sendSimulationEmail` を呼び出すのみです。

## 画面フロー概要

1. 同意と前提条件の確認
2. 基礎情報（年齢・郵便番号）
3. 年収・他借入・自己資金のヒアリング（1問ずつ）
4. 土地の有無を確認
5. 借入可能上限（MaxLoan）の提示
6. 希望返済額・返済期間・ボーナス返済の入力
7. スライダーで微調整し WishLoan と延床目安を更新
8. 結果保存と完了画面（メール送信は未実装）

各画面に注意文言を掲示し、金額はすべて「万円」単位で入力します（1を入力すると1万円として保存・計算されます）。結果表示時は円記号＋3桁区切りでフォーマットされ、微調整画面では MaxLoan と WishLoan の比率をプログレスバーで表示し、坪数・平米数の目安も同時に更新します。
